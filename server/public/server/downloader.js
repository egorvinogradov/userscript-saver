// Generated by CoffeeScript 1.3.3
var Taist;

Taist = {
  taisties: [],
  utils: {
    getTaistiesUrl: function() {
      return 'http://127.0.0.1:3000/server/taisties/' + location.hostname.replace(/(?:[a-z0-9\-]+\.)*?([a-z0-9\-]+\.[a-z]{2,4})$/i, '$1');
    },
    getTaistieState: function(id) {
      return localStorage.getItem(this.tmpl('taist_taistie_#{id}_state', {
        id: id
      }));
    },
    setTaistieState: function(id, state) {
      return localStorage.setItem(this.tmpl('taist_taistie_#{id}_state', {
        id: id
      }), state);
    },
    sendError: function(id, data) {
      return window.console && window.console.error && console.error('Taistie error (id: ' + id + ')', data);
    },
    tmpl: function(template, data) {
      var placeHolderRegExp, replace;
      data = data || {};
      placeHolderRegExp = /#\{(?:\s+)?([a-zA-Z0-9_]+)(?:\s+)?\}/g;
      replace = function(str, property) {
        return data[property] || '';
      };
      return template.replace(placeHolderRegExp, replace);
    },
    createEl: function(tagName, attributes) {
      var el, key;
      el = document.createElement(tagName);
      for (key in attributes) {
        el[key] = attributes[key];
      }
      return el;
    }
  },
  init: function() {
    var script;
    script = this.utils.createEl('script', {
      src: this.utils.getTaistiesUrl()
    });
    return document.body.appendChild(script);
  },
  applyTaisties: function(data) {
    var scriptData, scriptEl, styleEl, taistie, _i, _len;
    for (_i = 0, _len = data.length; _i < _len; _i++) {
      taistie = data[_i];
      scriptData = {
        jsCode: taistie.js,
        jsVars: this.utils.tmpl('{ id: #{id}, name: "#{name}", description: "#{description}" }', taistie)
      };
      scriptEl = this.utils.createEl('script', {
        innerHTML: this.utils.tmpl('(function(taistie){#{jsCode}}(#{jsVars}))', scriptData)
      });
      styleEl = this.utils.createEl('style', {
        innerHTML: taistie.css
      });
      this.taisties.push(taistie);
      if (!this.utils.getTaistieState(taistie.id)) {
        this.utils.setTaistieState(taistie.id, 'active');
      }
      document.body.appendChild(scriptEl);
      document.head.appendChild(styleEl);
    }
  }
};

Taist.init();
